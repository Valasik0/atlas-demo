<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Law Analyzer</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        /* Timeline styling */
        #timeline {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-top: 30px;
            margin-bottom: 50px;
            padding: 20px;
            border-radius: 10px;
            background: #f8f9fa;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .timeline-point {
            text-align: center;
            flex: 1;
            position: relative;
        }

        .timeline-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #007bff;
            margin: 0 auto;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }

        .timeline-date {
            font-size: 12px;
            margin-top: 8px;
            font-weight: bold;
        }

        .timeline-change {
            font-size: 11px;
            margin-top: 4px;
            color: #555;
        }

        #loading {
            display: none;
            margin-top: 20px;
            text-align: center;
        }

        .is-invalid {
            border-color: #dc3545 !important;
        }
    </style>
</head>
<body class="container mt-4">

<h2 class="mb-4">AI Legal Timeline Builder</h2>

<form th:action="@{/analyze-ui}" th:object="${lawRequest}" method="post">
    <div class="mb-3">
        <textarea class="form-control" id="currentText" th:field="*{currentText}" rows="3" placeholder="Zadejte aktuální znění"></textarea>
    </div>

    <div id="history-container">
        <h5>Starší verze</h5>
    </div>
    <button type="button" id="addHistoryBtn" class="btn btn-secondary mb-2">+</button>

    <div class="d-flex justify-content-end">
        <button id="analyzeBtn" type="button" class="btn btn-primary">Analyzovat</button>
    </div>
</form>

<div id="loading">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Analyzuji...</span>
    </div>
    <p>AI analyzuje změny, prosím čekejte...</p>
</div>

<div id="timeline"></div>

<script>
    const historyContainer = document.getElementById("history-container");
    const addHistoryBtn = document.getElementById("addHistoryBtn");
    const timeline = document.getElementById("timeline");
    const loading = document.getElementById("loading");

    function createHistoryBlock() {
        const wrapper = document.createElement("div");
        wrapper.className = "mb-3";

        wrapper.innerHTML = `
            <label class="form-label">Datum</label>
            <input type="date" class="form-control history-date" />
            <label class="form-label">Text</label>
            <textarea class="form-control history-text" rows="2" placeholder="Zadejte starší znění"></textarea>
        `;
        return wrapper;
    }

    historyContainer.appendChild(createHistoryBlock());

    addHistoryBtn.addEventListener("click", () => {
        historyContainer.appendChild(createHistoryBlock());
    });

    document.getElementById("analyzeBtn").addEventListener("click", async (event) => {
        event.preventDefault();

        document.querySelectorAll(".is-invalid").forEach(el => el.classList.remove("is-invalid"));

        const currentText = document.getElementById("currentText").value.trim();
        if (!currentText) {
            document.getElementById("currentText").classList.add("is-invalid");
            alert("Musíš zadat aktuální znění.");
            return;
        }

        const history = [];
        let invalid = false;

        const blocks = document.querySelectorAll("#history-container .mb-3");
        blocks.forEach(block => {
            const dateInput = block.querySelector(".history-date");
            const textInput = block.querySelector(".history-text");

            if (dateInput.value.trim() && textInput.value.trim()) {
                history.push({
                    date: dateInput.value,
                    text: textInput.value
                });
            } else if (dateInput.value.trim() || textInput.value.trim()) {
                dateInput.classList.add("is-invalid");
                textInput.classList.add("is-invalid");
                invalid = true;
            }
        });

        if (invalid) {
            alert("Vyplň datum i text u všech historických verzí.");
            return;
        }

        if (history.length === 0) {
            alert("Musíš zadat alespoň jednu starší verzi.");
            return;
        }

        const request = {
            currentText: currentText,
            history: history
        };

        console.log("Request odesílám:", request);

        loading.style.display = "block";
        timeline.innerHTML = "";

        try {
            const response = await fetch('/api/law/analyze-json', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(request)
            });

            let changes = await response.json();

            changes = changes.filter(c => c.date !== "aktuální")
                             .sort((a, b) => new Date(a.date) - new Date(b.date));

            const current = changes.find(c => c.date === "aktuální");
            if (current) changes.push(current);

            timeline.innerHTML = '';
            changes.forEach(item => {
                const point = document.createElement("div");
                point.className = "timeline-point";

                const circle = document.createElement("div");
                circle.className = "timeline-circle";

                const date = document.createElement("div");
                date.className = "timeline-date";
                date.innerText = item.date;

                const change = document.createElement("div");
                change.className = "timeline-change";
                change.innerText = item.change;

                point.appendChild(circle);
                point.appendChild(date);
                point.appendChild(change);
                timeline.appendChild(point);
            });
        } catch (err) {
            timeline.innerHTML = "<p class='text-danger'>Chyba při načítání dat</p>";
        } finally {
            loading.style.display = "none";
        }
    });
</script>
</body>
</html>
